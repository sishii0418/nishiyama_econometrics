# 第6章 パネルデータ分析 {-#ch6}
先に[出版社サイト](https://www.yuhikaku.co.jp/books/detail/9784641053854)よりデータをダウンロードする.
```{r collapse=T, eval=FALSE}
# サポートファイルへのリンク
curl <- "https://www.yuhikaku.co.jp/static_files/05385_support06.zip"
# ダウンロード保存用フォルダが存在しない場合, 作成
if(!dir.exists("downloads")){
    dir.create("downloads")
}
cdestfile <- "downloads/support06.zip"
download.file(curl, cdestfile)
# データ保存用フォルダが存在しない場合, 作成
if(!dir.exists("data")){
    dir.create("data")
}
# WSL上のRで解凍すると文字化けするので、Linuxのコマンドを外部呼び出し
# Windowsの場合は別途コマンドを用いる.
if(.Platform$OS.type == "unix") {
    system(sprintf('unzip -n -Ocp932 %s -d %s', "downloads/support06.zip", "./data"))
} else {
    print("Windowsで解凍するコマンドを別途追加せよ.")
}
```

必要なライブラリを読み込む.

```{r collapse=T}
library(tidyverse)
library(estimatr)
library(modelsummary)
library(fixest)
library(gt)
```

固定効果モデルをRで推定するためのパッケージは複数あり, これまで使ってきた`estimatr`のほかに`fixest`や`plm`などが挙げられる.
ここでは`estimatr`に加えて, 処理が高速とされる`fixest`での推定方法も記す.

## (6.1) 式 {#exp6.1 .unnumbered}
データ読込時, 本文中で分析されている通りに絞り込みを行う.
通常通り`estimatr::lm_robust()`で不均一分散を仮定して回帰するか, `feols()`を用いることもできる.
`feols()`では`vcov = "HC1"`と指定することでStataと同じ標準偏差を得られる.
```{r collapse=T}
yamaguchi <- read.csv("data/06_第6章/yamaguchi.csv")
yamaguchi <- yamaguchi %>%
                filter(year > 1999) %>%
                filter(hh.type == "all")

lm_robust(emp.rate ~ cap.rate, data = yamaguchi, se_type = "stata")
feols(emp.rate ~ cap.rate, vcov = "HC1", data = yamaguchi)
```

## 実証例6.1 保育所が母親の就業に与え影響の固定効果推定 {#ex6.1 .unnumbered}
固定効果モデルも`lm_robust()`で推定できる. `clusters`引数にクラスタのレベル, `fixed_effects`に固定効果の変数を指定する.
`feols`ではパイプ`|`の後ろに固定効果の変数を指定するのが本来の方法で, デフォルトでクラスター構造に頑健な標準誤差が得られるはずだが, なぜか異なる値となった. ご存じの方ご教授ください.
かわりに固定効果の変数とする`pref`を直接`formula`に足すことで, Stataと同じ標準誤差を得られた.
```{r collapse=T}
lm_robust(emp.rate ~ cap.rate, data = yamaguchi, clusters = pref, fixed_effects = pref, se_type = "stata")
feols(emp.rate ~ cap.rate + pref, cluster = ~pref, data = yamaguchi)
# このやり方のほうが直感的だと思うのですが, なぜか同じ標準誤差を得られず... ご存じの方ご教授ください.
# feols(emp.rate ~ cap.rate | pref, data = yamaguchi)
```

## 実証例6.2 保育所が母親の就業に与える影響の固定効果推定の標準誤差 {-}
[実証例6.1](#ex6.1)を参照せよ.

## 実証例6.3 保育所が母親の就業に与え影響のプールされたOLS推定の標準誤差 {.unnumbered}
自由度修正ホワイト標準誤差を得る式は[(6.1)式](#exp6.1)を参照せよ.
`lm_robust()`でクラスター構造に頑健な標準誤差を求めるには`clusters`引数を指定する.
一方`feols()`では`vcov`引数にクラスター構造を指定すればよい.
```{r collapse=T}
# クラスター構造に頑健な標準誤差
lm_robust(emp.rate ~ cap.rate, data = yamaguchi, clusters = pref, se_type = "stata")
feols(emp.rate ~ cap.rate, vcov = ~pref, data = yamaguchi)
```

## 実証例6.4 保育所が母親の就業に与える影響の時間効果を入れた分析 {.unnumbered}
`lm_robust()`では, `fixed_effects`引数に時間効果の変数`year`を指定する.
一方`feols()`では`formula`の後ろに`|`を付けて固定効果の変数を指定する.
```{r collapse=T}
lm_robust(emp.rate ~ cap.rate, data = yamaguchi, clusters = pref, fixed_effects = year, se_type = "stata")
feols(emp.rate ~ cap.rate | year, cluster = ~pref, data = yamaguchi)
```

## 実証例6.5 保育所が母親の就業に与える影響の都道府県効果と年効果を入れた分析 {.unnumbered}
`lm_robust()`では, `fixed_effects`引数に都道府県効果と年効果両方`pref + year`を指定する.
一方で`feols()`では[実証例6.1](#ex6.1)同様`pref`をパイプ`|`の後ろにいれると異なる標準誤差が出力されるため, やはり`formula`に直接加え, `cluster`引数に都道府県を指定する.
```{r collapse=T}
lm_robust(emp.rate ~ cap.rate, data = yamaguchi, clusters = pref, fixed_effects = pref + year, se_type = "stata")
feols(emp.rate ~ cap.rate + pref | year, cluster = ~pref, data = yamaguchi)
# 下では異なる標準誤差が出力される.
# feols(emp.rate ~ cap.rate | pref + year, cluster = ~pref, data = yamaguchi)
```

## 実証例6.6 保育所が母親の就業に与える影響の個別トレンドと年効果を入れた分析 {.unnumbered}
`lm_robust()`で複数の固定効果を入れるとき, `formula`や`fixed_effects`の指定の仕方によっては一部の変数が`NA`になるなど挙動がおかしくなることがある ([参考](https://keita43a.hatenablog.com/entry/2019/04/17/232548)).
`feols()`では, `formula`中に`i()`を使って固定効果変数を指定することで, 正しい標準誤差が得られるが, 正しい標準誤差が必要ない場合はコメントした3つめの方法のほうが速いとのこと (`feols`公式リファレンスのInteractionsの節を見よ).
```{r collapse=T}
lm_robust(emp.rate ~ cap.rate + pref + pref:year + factor(year), data = yamaguchi, clusters = pref, se_type = "stata")
feols(emp.rate ~ cap.rate + i(pref) + i(year) + i(pref, year), vcov = ~pref, data = yamaguchi)
# 係数の大きさは正しく, 速度も速い (はず) だが標準誤差が異なる.
# feols(emp.rate ~ cap.rate | pref + year + pref[year], vcov = ~pref, data = yamaguchi)
```

## 表6-3 記述統計量 {.unnumbered}
第5章の[表5-5](#table5-5)と同様に`datasummary()`を用いてデータフレームを書き出し, 適宜リネームを行えばよい.
```{r collapse=T, results='asis', message=FALSE}
# 変数を選択
vars <- yamaguchi %>%
    select(emp.rate, cap.rate, age, age.hus, emp.rate.hus, urate)
table63 <- datasummary(All(vars) ~ N + Mean + SD + Min + Max,
            output = "data.frame",
            data = yamaguchi,
            fmt = 3)
# 列名
colnames(table63) <- c("変数", "サンプルサイズ", "平均", "標準偏差", "最小値", "最大値")
# 変数名
table63[,1] <- c("母親就業率", "保育所定員率", "母親平均年齢", "父親平均年齢", "父親就業率", "失業率")
# 表を出力
gt(table63)
```

## 表6-4 年ごとの記述統計量 {.unnumbered}
やはり`datasummary()`を用いる. `formula`引数を適宜変更するだけで容易に作成できる.
```{r collapse=T, results='asis', message=FALSE}
# 変数を選択
table64 <- datasummary(emp.rate * (Mean + SD) + cap.rate * (Mean + SD) ~ factor(year),
            output = "data.frame",
            data = yamaguchi,
            fmt = 3)
# 列名
colnames(table64) <- c(" ", "変数", "2000", "2005", "2010") # tibbleの都合上1列目は空白1文字とする
# 変数名
table64[,1] <- c("母親就業率", "", "保育所定員率", "")
# 統計量を日本語に直す
table64[,2] <- c("平均", "標準偏差", "平均", "標準偏差")
# 表を出力
gt(table64)
```

<!-- ## 練習問題 6-1 [確認] {-}

## 練習問題 6-2 [確認] {-}

## 練習問題 6-3 [確認] {-}

## 練習問題 6-4 [確認] {-}

## 練習問題 6-5 [確認] {-}

## 練習問題 6-6 [確認] {-}

## 練習問題 6-7 [確認] {-}

## 練習問題 6-8 [発展] {-}

## 練習問題 6-9 [発展] {-}

## 練習問題 6-10 [実証] {-}

## 練習問題 6-11 [実証] {-} -->
